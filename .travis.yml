jobs:
  include:
    - stage: Test
      os: osx
      language: sh
      python: "3.6"
      name: "Mac OS - Python 3.6"
      addons:
        homebrew:
          packages:
            - python3
      before_install:
        - python3 -m pip install --upgrade pip wheel virtualenv
        - virtualenv venv -p python3
        - source venv/bin/activate
        - python --version
    - os: osx
      language: sh
      python: "2.7"
      name: "Mac OS - Python 2.7"
      before_install:
        - python -m pip install virtualenv
        - virtualenv venv -p python2
        - source venv/bin/activate
        - python --version
    - os: windows
      language: sh
      python: "3.6"
      name: "Windows - Python 3.6"
      before_install:
        - choco install python3 --version 3.6.5
        - export PATH="/c/Python36:/c/Python36/Scripts:$PATH"
        - python -m pip install --upgrade pip wheel virtualenv
        - python --version
    - os: windows
      language: sh
      python: "2.7"
      name: "Windows - Python 2.7"
      before_install:
        - choco install python2
        - export PATH="/c/Python27:/c/Python27/Scripts:$PATH"
        - python -m pip install --upgrade pip wheel
        - python --version
    - os: linux
      dist: xenial
      python: "3.6"
      language: python
      name: "Linux - Python 3.6"
    - os: linux
      dist: xenial
      python: "2.7"
      name: "Linux - Python 2.7"
      language: python

    - stage: "Deploy"
      if: branch = master AND type != pull_request
      script: python .multipackage/scripts/build_documentation.py
      os: linux
      dist: xenial
      python: "3.6"
      language: python
      name: "Documentation to Github Pages"
      deploy:
        - provider: pages
          skip-cleanup: true
          github-token: $GITHUB_TOKEN
          committer-from-gh: true
          keep-history: true
          local-dir: built_docs
      env:
        - secure: ey2dNOgfYyRn9AtjLNdXWsOPGrWyQjhFgD4p/KcwkKee6Shw54eDSfWs73r6Tl5/G9ySWi5ZlsVIcEaFxlIrtnX2Vu0GeC59wSoqYPqAlBvx6uVJAdbSNZyBEKHU7FJPH4H4WX7ozMwcJFipUKeW16y9bj9FRArc1nXxMCEhmHaGgF4tXoip96JA7zkC85orBgoBpbM6Gsbosv5SzIO+xzlGVqthbWlJGrODA+loeNN9uYrykyK1KFdJgVcB4db4s3ImWfzoSKwz8rBRmo+AcFmy8okXUzcDfQ+br/9y6eQT3leQ/HD9zY8W2UyxEPMDXCpzI415S4N5A0FHmIzYnpfKq3mXAd1pXzvc4kVLKBuSzYlZRt+UChrbtLsXbECw6+yFSRztqjrUl6bOYMi+weHEpbVVMzOZvX9pDP1bOJoqw1BM0uAA4nuXpORe6Q4dCfwZGSSGjsS3IHpnT7ZllrsdFNlVakh/iEPoFABPbXMKP486lzT7QWcwmpjECmYLl8W2xwjL/OibVXsu/mjx3MIh4yYSUbqBRpjTeUexnQ+Klfl75K+GlwwaHc9Jpc/anNwrHVM+Ab0O/3YYY8DUD3nxr8uDSCx87d8TvFRUdHg7FLrpataIN46EMTmg4Ao7U0GYAYO7YtERwCCtvkScAc/hLEB84eewBs2tACG0Gvo=
    - stage: "Deploy"
      if: tag IS present
      script: python .multipackage/scripts/release_by_name.py $TRAVIS_TAG
      os: linux
      dist: xenial
      python: "3.6"
      language: python
      name: "Release to PyPI Index"
      env:
        - secure: J7TlleG7YpW2i9fPkTje4p0rskeILSLchAcrYQejfqsoe5OvULiMwn5orqrzaiUd34rLib+II/a9NC6H0g/6c2C9n6n1XQHElhDFvG2bdGHFVL2WhKWZ4odc2fB82K3B5gxpSuhRDBuAK2RS+JUKzZ4vf+3AM4II1y3GYaxROmtz7S2sj5nSDoUbN5EB3A1YTee8OkURHHKFwkPS8l6RtwAAgeDJZjf0ZJjp3xfYSmR+lx4SmR1raU04HOzrtC4PmId6HjgjPqc1hc4qV0enxd5TFvtkKG407I91YWg3R+wn3JuBfXGJjRRRPIrzxjJIR2Us+V1QpG7fzteoORHIg71iUTFBmLrlVp73vdS+iF5qTYN43R54xp1xMaLSYbQWO4QDbF5aLQ19xLFf0MbUatQL4wYPrCTvsTWKi+Yb2LHN1o1y6zGSqjXp/8pwhR/2puRmQ6GzFloC6iaWraCtmI2swlsRe3E9WfHDr6BXtb2xiV6QmnD1DNX8nOJsq8AGHAe6yBZfz/jPOIEDA3GHxrS7OoU4RtOc6U1EnWW2sfRD7Bd4q7CLMRK/Qgbrv8jSkaUhdnYb/ZSMh2jw5AEUQtw1JGooLWBIqvYqbYx8TYYZX+hOVNW9c3kmDSqxphEp5wgLiGE/FWweTkPp8spYHZdO4ixF9z55rUvexnSxS90=
        - secure: Gy79weGXx15uq994CLQYM0GPl4lVtkBffRVzqdt8ccHA2LkEvaOv1ARMmzIw1POiVR+clplMt2pxZg/P01MtcE8wx4NGs0qI8ehyfcUTpkltuL7Yx/u63XzqndrPbuonaRruiXfsJD29Dhcj1AE8ObBA0ElSJxfuuapGX17FchgHnmUHUcGO863Q02A+GDhsrJ37GLMEBIJkgZqbKm1nErRaWazjkZK+OJ8wZZF+IVctGA9iZNSGPZK3PWatzv60ouSXE+GGKxaNe3le1PQ4d1AspTTOsQ66CF0GnAUyGZ/XOQaR5b2XWUp1rYkr5UdjBNzy6C6BUOHAaZa6DJRLRuG7hq9nqdV/0lLR58GO4wvRMgNwejuGO5nk+AUrE8FLiEzzLyJTx1CD+CP0r/S/lPYnQxq1ZZzYxpkG4KZcfZogKe+wll64UExkLw7jRI/G9nMjdDJFQjE+cqS6nbHls20cDNy+zOgL2AFoOdsGwuWXnOZfTgQALZ5KDe6HPJkuSE8hP+D0XS+mqKlnlZAwJIKqopkuTsXUvSCEAhJ67gCgAZRfRqeNmUpnpM0fV5HEWCpxKqyINAc223ixBaWOBYhP0j/XwbVr1C3wpHEs6so35Nr3Sx2IBs33Dla6xZpxF57f9KLiJ+6iQmx0jIYHRqfYG7MFuCrQGjySfEKTHCI=
        - secure: eX7qhj4kWJ1s4hhm+Bd/4I9VwVSmmVPagY+3lDErir6J0w0iAK8raUhO+oLTfKz9Ey0z20xY16KrXvWxb0S7x0rMYun+xbmeBVPT2/IEATUD9X2OHppVvGJOMFGUBVepFx8pNbSGzsf+Z6celn4f75rxmN7WMIcQZsccNHf8BmRi+OZMdY+btUuS6n8L5+pXjgXd9nhBXp6pD5Y/ksEBbq7gOBHCx2kZaE9A2yE/T8jzYgjJUVeh8FcREMS2X+DY4wWluclZbyc8XOE3OTMrtEPw3P/UUv/uC44DmHEOdzlbRvpOBDTOzEOtROEN4ne21bNMIlaYn5buA3fZW0PN5DMSAKJ8ThBUK+tXRbfsJH9kRFadlk+Si5GZSDAiPUBmaXP8DYy0UboTdWlmOJBSbpE03PmVaZdT6/xV3RyxrqS82aiZrX8hjnSwcrtjmqBZDEl8vuXXr4D6nQ2IBwLYt97n+Ukumk7eBw/O+nscAuAvJcErDkF5rfIUoI1ziDiBh/oJhOz0RuLMuDWSC/5YvD2WnYUUtB4gFj/f1yvT2NMjM+pU8kUbuJziEGNMm+2gQ+HsLXfDkf0Af8fwk//8AbIa4mDk4avC9+u0TH4YyzcWjRiqShPcNpvLzP7xezaorZ2HliIXZ4zERoLXu1mJ33Sf9OdR2gXg6Tqln5Yr0Do=

install:
- pip install -r requirements_build.txt -r requirements_doc.txt
- pip install ./iotile_analytics_core
- pip install ./iotile_analytics_interactive
- pip install ./iotile_analytics_offline

script:
- python .multipackage/scripts/test_by_name iotile_analytics_core
- python .multipackage/scripts/test_by_name iotile_analytics_interactive
- python .multipackage/scripts/test_by_name iotile_analytics_offline
- python .multipackage/scripts/build_documentation.py

notifications:
  email: false
  slack:
    rooms:
    - secure: S1K/OQx5xEod3ta+a7D4GsX5JH84mxRsQSCwy5OJpUyQ0I0SyNb1viDOyJuGAW2X3sSKISQlcWNpzhalrgLuAfAq2559dCEX6W85zev2y4SR/ElpmD5dJBLaDkpV/uIM5H0OFQ37ch99mr0j95wD9XkZTLoNkLSaVxvS31fosFqfOTImZ14M2DYj42Lyw1pIvpm4cdGEdSPP7ScnGNiplpQfWLTynjoV4TX+BnXR06F6wSTAwgYihwPmbrQMAFKk/526nfrTOQR5S32vZVFQLZpp2+Y/HrGoS2heSq2zURLY3hXIIj6HqZ3ACigeOPAFYe1Fr+KXzonOo3mxEl49HS/huKKQ+icnZHtmKFNzcJ1qFyfATcvFmemKAcjvnM5QBXQSG24LhxpeqXPFMZNpMhPzlQnITeiPoOyf8/bWU0Tf5I6AONV9/082y3ZL1sWJ4w7vVA/c5HaRGi+dZra/03eRX1KhS4SixI8Um/Cs7Lsdz2IdTMemXi3KNpUk02pdSJpef7J1NjFLNayLOPZ2WYGdHDm/MEnCpAsPxo9RHjH+DmTj2LTVtnz+L39EOg82w6lEhEzqHSammGA4iFGBuanLPukCCS0wYaebkL8X17o5MOhpUauF4LxpIgc65syGjzQkRcFrRbyvjpkP+uDXmZq0uNKuz2wiv/DnTJYa1I8=
    template:
    - "Build <%{build_url}|#%{build_number}> (<%{compare_url}|%{commit}>) of %{repository_slug}@%{branch} in PR <%{pull_request_url}|#%{pull_request_number}> by %{author} %{result} in %{elapsed_time}"
    on_success: always
    on_failure: always